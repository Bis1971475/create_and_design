<section class="checkout-page">
  <div class="checkout-shell">
    <header class="checkout-header">
      <p class="eyebrow">Create And Design</p>
      <h2>Finalizar pedido</h2>
      <p class="subtitle">Pedidos con minimo 3 dias de anticipacion para asegurar calidad y entrega.</p>
    </header>

    @if (items().length === 0 && !orderPlaced) {
      <div class="state-card">
        <p>No hay productos en el carrito.</p>
        <a class="btn btn-primary" routerLink="/products">Ir al catalogo</a>
      </div>
    }

    @if (items().length > 0 && !orderPlaced) {
      <div class="checkout-grid">
        <form class="checkout-form" (ngSubmit)="placeOrder()">
          <h3>Datos de entrega</h3>

          <label>
            Nombre completo
            <input type="text" name="customerName" [(ngModel)]="customerName" required />
          </label>

          <label>
            Telefono
            <input
              type="tel"
              name="phone"
              [(ngModel)]="phone"
              placeholder="Ej: 55 1234 5678"
              required
              pattern="^[0-9+\\s-]{10,20}$"
            />
          </label>
          @if (phone && !isPhoneValid) {
            <p class="input-error">Ingresa un telefono valido (10 a 15 digitos).</p>
          }

          <div class="row">
            <label>
              Fecha de entrega
              <input
                type="date"
                name="deliveryDate"
                [min]="minDeliveryDate"
                [(ngModel)]="deliveryDate"
                required
              />
            </label>
          </div>

          <h3>Tipo de entrega</h3>
          <div class="payment-options">
            <label class="pay-option">
              <input type="radio" name="deliveryMode" value="domicilio" [(ngModel)]="deliveryMode" />
              <span>A domicilio (+$50)</span>
            </label>
            <label class="pay-option">
              <input type="radio" name="deliveryMode" value="sucursal" [(ngModel)]="deliveryMode" />
              <span>Recoger en sucursal ($0)</span>
            </label>
          </div>

          @if (deliveryDate && !isDateValid) {
            <p class="input-error">La fecha debe ser minimo con 3 dias de anticipacion.</p>
          }

          @if (deliveryMode === 'domicilio') {
            <label>
              Direccion de entrega
              <textarea
                name="address"
                rows="3"
                [(ngModel)]="address"
                placeholder="Calle y numero, colonia, municipio y referencias"
                required
              ></textarea>
            </label>
            @if (address && !isAddressDetailed) {
              <p class="input-error">Escribe una direccion completa con calle, numero y referencia.</p>
            }
          }

          @if (deliveryMode === 'sucursal') {
            <p class="transfer-info">Seleccionaste recoger en sucursal. No se agrega costo de envio.</p>
          }

          <label>
            Indicaciones adicionales (opcional)
            <textarea name="notes" rows="3" [(ngModel)]="notes"></textarea>
          </label>

          <h3>Metodo de pago</h3>
          <div class="payment-options">
            <label class="pay-option">
              <input type="radio" name="paymentMethod" value="efectivo" [(ngModel)]="paymentMethod" />
              <span>Efectivo</span>
            </label>
            <label class="pay-option">
              <input type="radio" name="paymentMethod" value="transferencia" [(ngModel)]="paymentMethod" />
              <span>Transferencia</span>
            </label>
          </div>

          @if (paymentMethod === 'efectivo') {
            <label>
              Cambio para (opcional)
              <input type="text" name="cashChangeFor" [(ngModel)]="cashChangeFor" placeholder="Ej: 1000" />
            </label>
          }

          @if (paymentMethod === 'transferencia') {
            @if (transferClabe) {
              <div class="transfer-info">
                <p>CLABE para transferencia:</p>
                <strong>{{ transferClabe }}</strong>
              </div>
            }
            <label>
              Referencia de transferencia
              <input type="text" name="transferReference" [(ngModel)]="transferReference" required />
            </label>
          }

          @if (errorMessage) {
            <p class="input-error">{{ errorMessage }}</p>
          }

          <button class="btn btn-primary" type="submit" [disabled]="!isFormValid || isSubmitting">
            {{ isSubmitting ? 'Registrando pedido...' : 'Confirmar pedido' }}
          </button>
        </form>

        <aside class="summary-card">
          <h3>Resumen</h3>
          <div class="summary-items">
            @for (item of items(); track item.product.id) {
              <div class="summary-row">
                <p>{{ item.product.name }} x{{ item.quantity }}</p>
                <p>${{ item.product.price * item.quantity }}</p>
              </div>
            }
          </div>
          <div class="summary-row">
            <p>Subtotal</p>
            <p>${{ totalPrice() }}</p>
          </div>
          <div class="summary-row">
            <p>Entrega</p>
            <p>${{ deliveryFee }}</p>
          </div>
          <div class="summary-total">
            <p>Total</p>
            <p>${{ totalWithDelivery }}</p>
          </div>
        </aside>
      </div>
    }

    @if (orderPlaced) {
      <div class="state-card success">
        <h3>Pedido confirmado</h3>
        <p>Gracias por tu compra. Preparamos tu arreglo floral con mucho cuidado.</p>
        @if (createdOrderId) {
          <p><strong>Folio:</strong> {{ createdOrderId }}</p>
        }
        <a class="btn btn-primary" routerLink="/products">Seguir comprando</a>
      </div>
    }
  </div>
</section>
